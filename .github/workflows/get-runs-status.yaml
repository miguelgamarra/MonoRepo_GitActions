name: Update README with Workflow Runs

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch workflow runs and update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import requests
          from datetime import datetime

          headers = {
              "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
              "Accept": "application/vnd.github+json"
          }

          repo = os.environ["REPO"]
          url = f"https://api.github.com/repos/{repo}/actions/runs?per_page=5"

          response = requests.get(url, headers=headers)
          response.raise_for_status()

          runs = response.json()["workflow_runs"]

          table = [
              "## Last 5 Workflow Runs",
              "",
              "| Workflow | Status | Conclusion | Created At | Link |",
              "|----------|--------|------------|------------|------|"
          ]

          for run in runs:
              created = datetime.fromisoformat(run["created_at"].replace("Z", ""))
              table.append(
                  f"| {run['name']} | {run['status']} | {run['conclusion']} | "
                  f"{created.strftime('%Y-%m-%d %H:%M:%S')} | "
                  f"[Link]({run['html_url']}) |"
              )

          with open("README.md", "r") as f:
              content = f.read()

          marker = "## Last 5 Workflow Runs"
          if marker in content:
              content = content.split(marker)[0].rstrip()

          content += "\n\n" + "\n".join(table) + "\n"

          with open("README.md", "w") as f:
              f.write(content)
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update workflow runs table" || echo "No changes"
          git push
